#include <stdio.h>
#include <unistd.h>
#include <time.h>
#include <pthread.h>
#include <semaphore.h>
#include <sys/stat.h> /* For mode constants */

#define P(sem_value) sem_wait((sem_value));
#define V(sem_value) sem_post((sem_value));


pthread_mutex_t mutex1 = PTHREAD_MUTEX_INITIALIZER;
pthread_mutex_t mutex2 = PTHREAD_MUTEX_INITIALIZER;
pthread_mutex_t mutex3 = PTHREAD_MUTEX_INITIALIZER;
pthread_mutex_t mutex4 = PTHREAD_MUTEX_INITIALIZER;

sem_t *sem;


void* thread_1_non_synchro(void* arg) {
    sleep(1);
    printf("je ");
    sleep(1);
    printf("mes ");
    return NULL;
}

void* thread_2_non_synchro(void* arg) {
    sleep(1);
    printf("synchronise ");
    sleep(1);
    printf("threads \n");
    return NULL;
}

void* thread_1_synchro_mutex(void* arg) {

    printf("je ");
    pthread_mutex_unlock(&mutex2);

    pthread_mutex_lock(&mutex3);
    printf("mes ");
    pthread_mutex_unlock(&mutex4);


    return NULL;
}

void* thread_2_synchro_mutex(void* arg) {

    pthread_mutex_lock(&mutex2);
    printf("synchronise ");
    pthread_mutex_unlock(&mutex3);

    pthread_mutex_lock(&mutex4);
    printf("threads \n");
    return NULL;
}
int main(void)
{
    int nbChoice;
    pthread_mutex_init(&mutex1, NULL);
    pthread_mutex_init(&mutex2, NULL);
    pthread_mutex_init(&mutex3, NULL);

    while(nbChoice!=5) {

        printf("Quel mode de synchro voulez vous pour l'affichage de le phrase : \n");
        printf("1) Sans synchro\n");
        printf("2) Synchro avec mutex\n");
        printf("3) Synchro avec semaphore\n");
        printf("4) Les 3 versions a la suite\n");
        printf("5) Quitter le programme\n");
        scanf("%d", &nbChoice);

        switch(nbChoice) {
            case 1: {
                // -- Création des espaces threads -- //
                pthread_t thread_1, thread_2;

                // -- On créer les threads -- //
                pthread_create(&thread_1, NULL, thread_1_non_synchro, NULL);
                pthread_create(&thread_2, NULL, thread_2_non_synchro, NULL);

                // -- Ici on attend la fin d'executions des threads -- //
                pthread_join(thread_1, NULL);
                pthread_join(thread_2, NULL);

                break;
            }
            case 2: {
                pthread_t thread_1_mutex, thread_2_mutex;
                pthread_mutex_lock(&mutex2);
                pthread_mutex_lock(&mutex3);
                pthread_mutex_lock(&mutex4);
                // -- On créer les threads -- //
                pthread_create(&thread_1_mutex, NULL, thread_1_synchro_mutex, NULL);
                pthread_create(&thread_2_mutex, NULL, thread_2_synchro_mutex, NULL);

                // -- Ici on attend la fin d'executions des threads -- //
                pthread_join(thread_1_mutex, NULL);
                pthread_join(thread_2_mutex, NULL);

                break;
            }
            case 3:
                printf("Synchro avec semaphore\n");
                sem = sem_init(sem, 0, 1);

                break;
            case 4:
                printf("Les 3 versions a la suite\n");
                break;
            case 5:
                printf("Quitter le programme\n");
                break;
        }

        sleep(3);
        system("cls");
    }

    pthread_mutex_destroy(&mutex1);
    pthread_mutex_destroy(&mutex2);
    pthread_mutex_destroy(&mutex3);
    pthread_mutex_destroy(&mutex4);

    return 0;
}