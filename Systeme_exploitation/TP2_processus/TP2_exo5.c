#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <time.h>
#include <string.h>
#include <sys/types.h>
#include <sys/wait.h>

int main() {
    int pipe_fils_vers_pere[2]; 
    int pipe_pere_vers_fils[2]; 

    pipe(pipe_fils_vers_pere);
    pipe(pipe_pere_vers_fils);

    pid_t fils = fork();

    if (fils < 0) {
        perror("Erreur fork");
        return 1;
    }

    if (fils == 0) {

        close(pipe_fils_vers_pere[0]); 
        close(pipe_pere_vers_fils[1]); 
        int devine = 0;
        char reponse[10];

        do {

            devine = rand() % 40+ 1;
            write(pipe_fils_vers_pere[1], &devine, sizeof(int));
            printf("[FILS] Je propose : %d\n", devine);

            // Attend la réponse du père
            read(pipe_pere_vers_fils[0], reponse, sizeof(reponse));
            printf("[FILS] Le père répond : %s\n", reponse);

            sleep(1);
        } while (strcmp(reponse, "trouvé") != 0);

        close(pipe_fils_vers_pere[1]);
        close(pipe_pere_vers_fils[0]);
        exit(0);

    } else {
        close(pipe_fils_vers_pere[1]);
        close(pipe_pere_vers_fils[0]);

        srand(time(NULL));
        int secret = rand() % 40+ 1;
        int received = 0;
        char feedback[10];

        printf("[PERE] Nombre mystère = %d\n", secret);

        while (1) {
            read(pipe_fils_vers_pere[0], &received, sizeof(int));

            if (received < secret)
                strcpy(feedback, "plus");
            else if (received > secret)
                strcpy(feedback, "moins");
            else {
                strcpy(feedback, "trouvé");
                write(pipe_pere_vers_fils[1], feedback, sizeof(feedback));
                break;
            }

            write(pipe_pere_vers_fils[1], feedback, sizeof(feedback));
        }

        close(pipe_fils_vers_pere[0]);
        close(pipe_pere_vers_fils[1]);

        wait(NULL);
        printf("[PERE] Le fils a trouvé le bon nombre !\n");
    }

    return 0;
}
